sudo: required # needed for trusty beta
dist: trusty   # needed for HarfBuzz

language: c

compiler:
  - clang
  - gcc

addons:
  apt:
    update: true
    sources:
      - sourceline: 'ppa:as-bahanta/raqm'
      - sourceline: 'ppa:dns/gnu'
    packages:
      - libraqm-dev
      - libfreetype6-dev
      - libharfbuzz-dev
      - libfribidi-dev

matrix:
  include:
    os: linux-ppc64le
    sudo: false
    compiler: gcc-8
    addons:
      apt:
        update: true
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - libfreetype6-dev
          - libharfbuzz-dev
          - libfribidi-dev
          - gcc-8
          - g++-8
          - ocl-icd-opencl-dev
          - liblcms2-dev
          - libautotrace-dev
          - librsvg2-dev
          - libfftw3-dev
          - libopenjp2-7-dev
          - libpango1.0-dev
          - libraw-dev
          - libwebp-dev
          - libltdl-dev
          - libimage-magick-perl

    script: |
      set -e
      set -x
      export CXX=${CC/cc/++}
      export OMP_NUM_THREADS=1
      export CFLAGS="-Wno-deprecated-declarations -Wdeclaration-after-statement -Wno-error=unused-variable"
      ./configure --disable-openmp --with-quantum-depth=16 --enable-hdri=no --without-perl --prefix=/usr
      make
      make install DESTDIR=$(readlink -f appdir)

    after_success:
      - true

script: |
  set -e
  set -x
  export OMP_NUM_THREADS=1
  export CFLAGS="-Wno-deprecated-declarations -Wdeclaration-after-statement -Wno-error=unused-variable"
  ./configure --disable-openmp --with-quantum-depth=16 --enable-hdri=no --without-perl --prefix=/usr
  make
  make install DESTDIR=$(readlink -f appdir)
  # Build the fuzzers
  ./.travis/build_fuzzers.sh
  # Generate AppImage
  mkdir -p appdir/usr/share/applications/ ; cp imagemagick.desktop appdir/usr/share/applications/
  mkdir -p appdir/usr/share/icons/hicolor/128x128/apps/ ; touch appdir/usr/share/icons/hicolor/128x128/apps/imagemagick.png # FIXME
  wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
  chmod a+x linuxdeployqt*.AppImage
  unset QTDIR; unset QT_PLUGIN_PATH ; unset LD_LIBRARY_PATH
  export VERSION=$(git rev-parse --short HEAD)-$CC
  ./linuxdeployqt*.AppImage ./appdir/usr/share/applications/imagemagick.desktop -bundle-non-qt-libs
  ./linuxdeployqt*.AppImage --appimage-extract
  rm ./appdir/AppRun ; cp AppRun appdir/ ; chmod a+x ./appdir/AppRun # Replace symlink with custom script
  PATH=./squashfs-root/usr/bin:$PATH ./squashfs-root/usr/bin/appimagetool -g ./appdir/

after_success:
  - find ./appdir -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq
  - if [ "$TRAVIS_BRANCH" == "$TRAVIS_TAG" ] ; then wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh ; bash upload.sh ImageMagick*AppImage* ; fi
  - if [ "$TRAVIS_BRANCH" != "$TRAVIS_TAG" ] ; then curl --upload-file ./ImageMagick*.AppImage https://transfer.sh/ImageMagick-git.$(git rev-parse --short HEAD)-x86_64.AppImage ; fi
